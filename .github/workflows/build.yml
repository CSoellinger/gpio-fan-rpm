name: Build Test

on:
  # Trigger on tags starting with 'v'
  push:
    tags:
      - 'v*'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-test:
    name: Test Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            autoconf \
            automake \
            libtool \
            pkg-config \
            autoconf-archive \
            libjson-c-dev

      - name: Build libgpiod v2 from source
        run: |
          git clone --depth 1 --branch v2.1.3 https://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git /tmp/libgpiod
          cd /tmp/libgpiod
          ./autogen.sh --enable-tools=yes --enable-static=yes --prefix=/usr
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_STATIC=ON ..

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Test binary
        run: |
          cd build
          ./gpio-fan-rpm --version
          ./gpio-fan-rpm --help

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: gpio-fan-rpm-x86_64
          path: build/gpio-fan-rpm
          retention-days: 30
